#!/bin/bash
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -exuo pipefail

proj=mailur
lxc_name=${lxc_name:-mlr}
mount_src=${lxc_src-$(pwd)}
no_login=${no_login:-}

lxc-create -t download -n $lxc_name -- -d centos -r 7 -a amd64

# mount src from host and also some cache directories
[ -z "$mount_src" ] || (
cat <<EOF >> /var/lib/lxc/$lxc_name/config
lxc.mount.entry = $mount_src opt/$proj none bind,create=dir
EOF
)

lxc-start -n $lxc_name
sleep 5

# install ssh and authorized keys for easy access
cat <<EOF | lxc-attach --clear-env -n $lxc_name -- /bin/sh
set -exu

systemctl start network

yum update -y

cat <<EOF2 > /etc/profile.d/activate.sh
if [ -d /opt/$proj ]; then
    cd /opt/$proj
    . bin/activate
fi
EOF2
EOF

[ -n "$no_login" ] || lxc-attach --clear-env -n $lxc_name
