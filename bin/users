#!/bin/bash
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -exuo pipefail
. bin/activate

home=${home:-"/home/vmail"}
pass=${pass:-\{plain\}user}
names=${user:-"user"}
fields=${fields:-}
append=${append:-}

users=/etc/dovecot/passwd.users
[ -n "$append" ] || : > $users
for user in $names; do
    echo "$user:$pass::::$home/$user::$fields" >> $users
done

# virtual mailboxes
for user in $names; do
    home=$home/$user bin/virtual
done
chown -R vmail:vmail $home
