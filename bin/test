#!/bin/bash
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -exuo pipefail

root=$(dirname $(readlink -f $0))
lxc_name=mlr-test
lxc-destroy -fn $lxc_name || true

export lxc_name
$root/lxc

cat << EOF | ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $(lxc-info -n $lxc_name -iH)
set -exuo pipefail

cd /opt/mailur
bin/install

apk add git

set +ux
. env/bin/activate
set -ux

pip install -e .[test]

mailur lint --ci
mailur test -- -v

yarn run build
EOF
